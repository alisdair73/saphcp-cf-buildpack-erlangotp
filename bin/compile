#!/bin/bash

##
# usage: bin/compile <build-dir> <cache-dir>
set -e
bpdir=$(cd $(dirname $(dirname $0)); pwd)
mkdir -p "$1" "$2"
build=$(cd "$1/" && pwd)
test -z ${build} && exit

ERLROOT=${build}
PROFILE=${build}/.profile.d

echo $PORT

echo "-------> Download and Build Erlang/OTP"
#mkdir -p ${ERLROOT}
cd ${ERLROOT}

git clone https://github.com/erlang/otp.git

cd otp
export ERL_TOP=$PWD
export PATH=$ERL_TOP/bin:$PATH
./otp_build autoconf
./configure --prefix=/app/otp

make
make install

echo $(erl -version)
echo $(ls -R ${ERLROOT}/otp/bin)

PATH=/app/otp/bin:$PATH
export PATH

cd $build

if [ ! -e "rebar" ]; then
  echo "-----> Installing Rebar from buildpack"
  cp ${bpdir}/opt/rebar ./
fi

echo "-----> Building with Rebar"
unset GIT_DIR
./rebar get-deps compile 2>&1 | sed -u 's/^/       /'
if [ ${PIPESTATUS[0]} -ne 0 ]; then
  echo "-----> Build failed"
  exit 1
fi

if [ -f ${bpdir}/opt/otp.sh ]; then
  mkdir -p ${PROFILE}
  cp ${bpdir}/opt/otp.sh ${PROFILE}
fi

echo "-----> Build succeeded"